<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Mutex, Send and Arc - 100 Exercises To Learn Rust</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../01_intro/00_welcome.html"><strong aria-hidden="true">1.</strong> Welcome</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../01_intro/01_syntax.html"><strong aria-hidden="true">1.1.</strong> Syntax</a></li></ol></li><li class="chapter-item expanded "><a href="../02_basic_calculator/00_intro.html"><strong aria-hidden="true">2.</strong> A Basic Calculator</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../02_basic_calculator/01_integers.html"><strong aria-hidden="true">2.1.</strong> Integers</a></li><li class="chapter-item expanded "><a href="../02_basic_calculator/02_variables.html"><strong aria-hidden="true">2.2.</strong> Variables</a></li><li class="chapter-item expanded "><a href="../02_basic_calculator/03_if_else.html"><strong aria-hidden="true">2.3.</strong> Branching: if/else</a></li><li class="chapter-item expanded "><a href="../02_basic_calculator/04_panics.html"><strong aria-hidden="true">2.4.</strong> Panics</a></li><li class="chapter-item expanded "><a href="../02_basic_calculator/05_factorial.html"><strong aria-hidden="true">2.5.</strong> Factorial</a></li><li class="chapter-item expanded "><a href="../02_basic_calculator/06_while.html"><strong aria-hidden="true">2.6.</strong> Loops: while</a></li><li class="chapter-item expanded "><a href="../02_basic_calculator/07_for.html"><strong aria-hidden="true">2.7.</strong> Loops: for</a></li><li class="chapter-item expanded "><a href="../02_basic_calculator/08_overflow.html"><strong aria-hidden="true">2.8.</strong> Overflow and underflow</a></li><li class="chapter-item expanded "><a href="../02_basic_calculator/09_saturating.html"><strong aria-hidden="true">2.9.</strong> Saturating arithmetic</a></li><li class="chapter-item expanded "><a href="../02_basic_calculator/10_as_casting.html"><strong aria-hidden="true">2.10.</strong> Conversions: as casting</a></li></ol></li><li class="chapter-item expanded "><a href="../03_ticket_v1/00_intro.html"><strong aria-hidden="true">3.</strong> Ticket v1</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../03_ticket_v1/01_struct.html"><strong aria-hidden="true">3.1.</strong> Structs</a></li><li class="chapter-item expanded "><a href="../03_ticket_v1/02_validation.html"><strong aria-hidden="true">3.2.</strong> Validation</a></li><li class="chapter-item expanded "><a href="../03_ticket_v1/03_modules.html"><strong aria-hidden="true">3.3.</strong> Modules</a></li><li class="chapter-item expanded "><a href="../03_ticket_v1/04_visibility.html"><strong aria-hidden="true">3.4.</strong> Visibility</a></li><li class="chapter-item expanded "><a href="../03_ticket_v1/05_encapsulation.html"><strong aria-hidden="true">3.5.</strong> Encapsulation</a></li><li class="chapter-item expanded "><a href="../03_ticket_v1/06_ownership.html"><strong aria-hidden="true">3.6.</strong> Ownership</a></li><li class="chapter-item expanded "><a href="../03_ticket_v1/07_setters.html"><strong aria-hidden="true">3.7.</strong> Setters</a></li><li class="chapter-item expanded "><a href="../03_ticket_v1/08_stack.html"><strong aria-hidden="true">3.8.</strong> Stack</a></li><li class="chapter-item expanded "><a href="../03_ticket_v1/09_heap.html"><strong aria-hidden="true">3.9.</strong> Heap</a></li><li class="chapter-item expanded "><a href="../03_ticket_v1/10_references_in_memory.html"><strong aria-hidden="true">3.10.</strong> References in memory</a></li><li class="chapter-item expanded "><a href="../03_ticket_v1/11_destructor.html"><strong aria-hidden="true">3.11.</strong> Destructors</a></li><li class="chapter-item expanded "><a href="../03_ticket_v1/12_outro.html"><strong aria-hidden="true">3.12.</strong> Outro</a></li></ol></li><li class="chapter-item expanded "><a href="../04_traits/00_intro.html"><strong aria-hidden="true">4.</strong> Traits</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../04_traits/01_trait.html"><strong aria-hidden="true">4.1.</strong> Trait</a></li><li class="chapter-item expanded "><a href="../04_traits/02_orphan_rule.html"><strong aria-hidden="true">4.2.</strong> Orphan rule</a></li><li class="chapter-item expanded "><a href="../04_traits/03_operator_overloading.html"><strong aria-hidden="true">4.3.</strong> Operator overloading</a></li><li class="chapter-item expanded "><a href="../04_traits/04_derive.html"><strong aria-hidden="true">4.4.</strong> Derive macros</a></li><li class="chapter-item expanded "><a href="../04_traits/05_trait_bounds.html"><strong aria-hidden="true">4.5.</strong> Trait bounds</a></li><li class="chapter-item expanded "><a href="../04_traits/06_str_slice.html"><strong aria-hidden="true">4.6.</strong> String slices</a></li><li class="chapter-item expanded "><a href="../04_traits/07_deref.html"><strong aria-hidden="true">4.7.</strong> Deref trait</a></li><li class="chapter-item expanded "><a href="../04_traits/08_sized.html"><strong aria-hidden="true">4.8.</strong> Sized trait</a></li><li class="chapter-item expanded "><a href="../04_traits/09_from.html"><strong aria-hidden="true">4.9.</strong> From trait</a></li><li class="chapter-item expanded "><a href="../04_traits/10_assoc_vs_generic.html"><strong aria-hidden="true">4.10.</strong> Associated vs generic types</a></li><li class="chapter-item expanded "><a href="../04_traits/11_clone.html"><strong aria-hidden="true">4.11.</strong> Clone trait</a></li><li class="chapter-item expanded "><a href="../04_traits/12_copy.html"><strong aria-hidden="true">4.12.</strong> Copy trait</a></li><li class="chapter-item expanded "><a href="../04_traits/13_drop.html"><strong aria-hidden="true">4.13.</strong> Drop trait</a></li><li class="chapter-item expanded "><a href="../04_traits/14_outro.html"><strong aria-hidden="true">4.14.</strong> Outro</a></li></ol></li><li class="chapter-item expanded "><a href="../05_ticket_v2/00_intro.html"><strong aria-hidden="true">5.</strong> Ticket v2</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../05_ticket_v2/01_enum.html"><strong aria-hidden="true">5.1.</strong> Enums</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/02_match.html"><strong aria-hidden="true">5.2.</strong> Branching: match</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/03_variants_with_data.html"><strong aria-hidden="true">5.3.</strong> Variants with data</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/04_if_let.html"><strong aria-hidden="true">5.4.</strong> Branching: if let and let/else</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/05_nullability.html"><strong aria-hidden="true">5.5.</strong> Nullability</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/06_fallibility.html"><strong aria-hidden="true">5.6.</strong> Fallibility</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/07_unwrap.html"><strong aria-hidden="true">5.7.</strong> Unwrap</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/08_error_enums.html"><strong aria-hidden="true">5.8.</strong> Error enums</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/09_error_trait.html"><strong aria-hidden="true">5.9.</strong> Error trait</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/10_packages.html"><strong aria-hidden="true">5.10.</strong> Packages</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/11_dependencies.html"><strong aria-hidden="true">5.11.</strong> Dependencies</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/12_thiserror.html"><strong aria-hidden="true">5.12.</strong> thiserror</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/13_try_from.html"><strong aria-hidden="true">5.13.</strong> TryFrom trait</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/14_source.html"><strong aria-hidden="true">5.14.</strong> Error::source</a></li><li class="chapter-item expanded "><a href="../05_ticket_v2/15_outro.html"><strong aria-hidden="true">5.15.</strong> Outro</a></li></ol></li><li class="chapter-item expanded "><a href="../06_ticket_management/00_intro.html"><strong aria-hidden="true">6.</strong> Ticket Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../06_ticket_management/01_arrays.html"><strong aria-hidden="true">6.1.</strong> Arrays</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/02_vec.html"><strong aria-hidden="true">6.2.</strong> Vectors</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/03_resizing.html"><strong aria-hidden="true">6.3.</strong> Resizing</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/04_iterators.html"><strong aria-hidden="true">6.4.</strong> Iterators</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/05_iter.html"><strong aria-hidden="true">6.5.</strong> Iter</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/06_lifetimes.html"><strong aria-hidden="true">6.6.</strong> Lifetimes</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/07_combinators.html"><strong aria-hidden="true">6.7.</strong> Combinators</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/08_impl_trait.html"><strong aria-hidden="true">6.8.</strong> impl Trait</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/09_impl_trait_2.html"><strong aria-hidden="true">6.9.</strong> impl Trait, pt.2</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/10_slices.html"><strong aria-hidden="true">6.10.</strong> Slices</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/11_mutable_slices.html"><strong aria-hidden="true">6.11.</strong> Mutable slices</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/12_two_states.html"><strong aria-hidden="true">6.12.</strong> Two states</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/13_index.html"><strong aria-hidden="true">6.13.</strong> Index trait</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/14_index_mut.html"><strong aria-hidden="true">6.14.</strong> IndexMut trait</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/15_hashmap.html"><strong aria-hidden="true">6.15.</strong> HashMap</a></li><li class="chapter-item expanded "><a href="../06_ticket_management/16_btreemap.html"><strong aria-hidden="true">6.16.</strong> BTreeMap</a></li></ol></li><li class="chapter-item expanded "><a href="../07_threads/00_intro.html"><strong aria-hidden="true">7.</strong> Threads</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../07_threads/01_threads.html"><strong aria-hidden="true">7.1.</strong> Threads</a></li><li class="chapter-item expanded "><a href="../07_threads/02_static.html"><strong aria-hidden="true">7.2.</strong> 'static lifetime</a></li><li class="chapter-item expanded "><a href="../07_threads/03_leak.html"><strong aria-hidden="true">7.3.</strong> Leaking memory</a></li><li class="chapter-item expanded "><a href="../07_threads/04_scoped_threads.html"><strong aria-hidden="true">7.4.</strong> Scoped threads</a></li><li class="chapter-item expanded "><a href="../07_threads/05_channels.html"><strong aria-hidden="true">7.5.</strong> Channels</a></li><li class="chapter-item expanded "><a href="../07_threads/06_interior_mutability.html"><strong aria-hidden="true">7.6.</strong> Interior mutability</a></li><li class="chapter-item expanded "><a href="../07_threads/07_ack.html"><strong aria-hidden="true">7.7.</strong> Ack pattern</a></li><li class="chapter-item expanded "><a href="../07_threads/08_client.html"><strong aria-hidden="true">7.8.</strong> Client</a></li><li class="chapter-item expanded "><a href="../07_threads/09_bounded.html"><strong aria-hidden="true">7.9.</strong> Bounded channels</a></li><li class="chapter-item expanded "><a href="../07_threads/10_patch.html"><strong aria-hidden="true">7.10.</strong> Patching</a></li><li class="chapter-item expanded "><a href="../07_threads/11_locks.html" class="active"><strong aria-hidden="true">7.11.</strong> Mutex, Send and Arc</a></li><li class="chapter-item expanded "><a href="../07_threads/12_rw_lock.html"><strong aria-hidden="true">7.12.</strong> RwLock</a></li><li class="chapter-item expanded "><a href="../07_threads/13_without_channels.html"><strong aria-hidden="true">7.13.</strong> Without channels</a></li><li class="chapter-item expanded "><a href="../07_threads/14_sync.html"><strong aria-hidden="true">7.14.</strong> Sync trait</a></li></ol></li><li class="chapter-item expanded "><a href="../08_futures/00_intro.html"><strong aria-hidden="true">8.</strong> Futures</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../08_futures/01_async_fn.html"><strong aria-hidden="true">8.1.</strong> Asynchronous functions</a></li><li class="chapter-item expanded "><a href="../08_futures/02_spawn.html"><strong aria-hidden="true">8.2.</strong> Spawning tasks</a></li><li class="chapter-item expanded "><a href="../08_futures/03_runtime.html"><strong aria-hidden="true">8.3.</strong> Runtime</a></li><li class="chapter-item expanded "><a href="../08_futures/04_future.html"><strong aria-hidden="true">8.4.</strong> Future trait</a></li><li class="chapter-item expanded "><a href="../08_futures/05_blocking.html"><strong aria-hidden="true">8.5.</strong> Blocking the runtime</a></li><li class="chapter-item expanded "><a href="../08_futures/06_async_aware_primitives.html"><strong aria-hidden="true">8.6.</strong> Async-aware primitives</a></li><li class="chapter-item expanded "><a href="../08_futures/07_cancellation.html"><strong aria-hidden="true">8.7.</strong> Cancellation</a></li><li class="chapter-item expanded "><a href="../08_futures/08_outro.html"><strong aria-hidden="true">8.8.</strong> Outro</a></li></ol></li><li class="chapter-item expanded "><a href="../going_further.html"><strong aria-hidden="true">9.</strong> Going further</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">100 Exercises To Learn Rust</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/mainmatter/100-exercises-to-learn-rust" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="locks-send-and-arc"><a class="header" href="#locks-send-and-arc">Locks, <code>Send</code> and <code>Arc</code></a></h1>
<p>The patching strategy you just implemented has a major drawback: it's racy.<br />
If two clients send patches for the same ticket roughly at same time, the server will apply them in an arbitrary order.
Whoever enqueues their patch last will overwrite the changes made by the other client.</p>
<h2 id="version-numbers"><a class="header" href="#version-numbers">Version numbers</a></h2>
<p>We could try to fix this by using a <strong>version number</strong>.<br />
Each ticket gets assigned a version number upon creation, set to <code>0</code>.<br />
Whenever a client sends a patch, they must include the current version number of the ticket alongside the
desired changes. The server will only apply the patch if the version number matches the one it has stored.</p>
<p>In the scenario described above, the server would reject the second patch, because the version number would
have been incremented by the first patch and thus wouldn't match the one sent by the second client.</p>
<p>This approach is fairly common in distributed systems (e.g. when client and servers don't share memory),
and it is known as <strong>optimistic concurrency control</strong>.<br />
The idea is that most of the time, conflicts won't happen, so we can optimize for the common case.
You know enough about Rust by now to implement this strategy on your own as a bonus exercise, if you want to.</p>
<h2 id="locking"><a class="header" href="#locking">Locking</a></h2>
<p>We can also fix the race condition by introducing a <strong>lock</strong>.<br />
Whenever a client wants to update a ticket, they must first acquire a lock on it. While the lock is active,
no other client can modify the ticket.</p>
<p>Rust's standard library provides two different locking primitives: <code>Mutex&lt;T&gt;</code> and <code>RwLock&lt;T&gt;</code>.<br />
Let's start with <code>Mutex&lt;T&gt;</code>. It stands for <strong>mut</strong>ual <strong>ex</strong>clusion, and it's the simplest kind of lock:
it allows only one thread to access the data, no matter if it's for reading or writing.</p>
<p><code>Mutex&lt;T&gt;</code> wraps the data it protects, and it's therefore generic over the type of the data.<br />
You can't access the data directly: the type system forces you to acquire a lock first using either <code>Mutex::lock</code> or
<code>Mutex::try_lock</code>. The former blocks until the lock is acquired, the latter returns immediately with an error if the lock
can't be acquired.<br />
Both methods return a guard object that dereferences to the data, allowing you to modify it. The lock is released when
the guard is dropped.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::sync::Mutex;

// An integer protected by a mutex lock
let lock = Mutex::new(0);

// Acquire a lock on the mutex
let mut guard = lock.lock().unwrap();

// Modify the data through the guard,
// leveraging its `Deref` implementation
*guard += 1;

// The lock is released when `data` goes out of scope
// This can be done explicitly by dropping the guard
// or happen implicitly when the guard goes out of scope
drop(guard)
<span class="boring">}</span></code></pre></pre>
<h2 id="locking-granularity"><a class="header" href="#locking-granularity">Locking granularity</a></h2>
<p>What should our <code>Mutex</code> wrap?<br />
The simplest option would be the wrap the entire <code>TicketStore</code> in a single <code>Mutex</code>.<br />
This would work, but it would severely limit the system's performance: you wouldn't be able to read tickets in parallel,
because every read would have to wait for the lock to be released.<br />
This is known as <strong>coarse-grained locking</strong>.</p>
<p>It would be better to use <strong>fine-grained locking</strong>, where each ticket is protected by its own lock.
This way, clients can keep working with tickets in parallel, as long as they aren't trying to access the same ticket.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// The new structure, with a lock for each ticket
struct TicketStore {
    tickets: BTreeMap&lt;TicketId, Mutex&lt;Ticket&gt;&gt;,
}
<span class="boring">}</span></code></pre></pre>
<p>This approach is more efficient, but it has a downside: <code>TicketStore</code> has to become <strong>aware</strong> of the multithreaded
nature of the system; up until now, <code>TicketStore</code> has been blissfully ignored the existence of threads.<br />
Let's go for it anyway.</p>
<h2 id="who-holds-the-lock"><a class="header" href="#who-holds-the-lock">Who holds the lock?</a></h2>
<p>For the whole scheme to work, the lock must be passed to the client that wants to modify the ticket.<br />
The client can then directly modify the ticket (as if they had a <code>&amp;mut Ticket</code>) and release the lock when they're done.</p>
<p>This is a bit tricky.<br />
We can't send a <code>Mutex&lt;Ticket&gt;</code> over a channel, because <code>Mutex</code> is not <code>Clone</code> and
we can't move it out of the <code>TicketStore</code>. Could we send the <code>MutexGuard</code> instead?</p>
<p>Let's test the idea with a small example:</p>
<pre><pre class="playground"><code class="language-rust">use std::thread::spawn;
use std::sync::Mutex;
use std::sync::mpsc::sync_channel;

fn main() {
    let lock = Mutex::new(0);
    let (sender, receiver) = sync_channel(1);
    let guard = lock.lock().unwrap();

    spawn(move || {
        receiver.recv().unwrap();;
    });

    // Try to send the guard over the channel
    // to another thread
    sender.send(guard);
}</code></pre></pre>
<p>The compiler is not happy with this code:</p>
<pre><code class="language-text">error[E0277]: `MutexGuard&lt;'_, i32&gt;` cannot be sent between threads safely
   --&gt; src/main.rs:10:7
    |
10  |   spawn(move || {
    |  _-----_^
    | | |
    | | required by a bound introduced by this call
11  | |     receiver.recv().unwrap();;
12  | | });
    | |_^ `MutexGuard&lt;'_, i32&gt;` cannot be sent between threads safely
    |
    = help: the trait `Send` is not implemented for `MutexGuard&lt;'_, i32&gt;`, which is required by `{closure@src/main.rs:10:7: 10:14}: Send`
    = note: required for `std::sync::mpsc::Receiver&lt;MutexGuard&lt;'_, i32&gt;&gt;` to implement `Send`
note: required because it's used within this closure
</code></pre>
<p><code>MutexGuard&lt;'_, i32&gt;</code> is not <code>Send</code>: what does it mean?</p>
<h2 id="send"><a class="header" href="#send"><code>Send</code></a></h2>
<p><code>Send</code> is a marker trait that indicates that a type can be safely transferred from one thread to another.<br />
<code>Send</code> is also an auto-trait, just like <code>Sized</code>; it's automatically implemented (or not implemented) for your type
by the compiler, based on its definition.<br />
You can also implement <code>Send</code> manually for your types, but it requires <code>unsafe</code> since you have to guarantee that the
type is indeed safe to send between threads for reasons that the compiler can't automatically verify.</p>
<h3 id="channel-requirements"><a class="header" href="#channel-requirements">Channel requirements</a></h3>
<p><code>Sender&lt;T&gt;</code>, <code>SyncSender&lt;T&gt;</code> and <code>Receiver&lt;T&gt;</code> are <code>Send</code> if and only if <code>T</code> is <code>Send</code>.<br />
That's because they are used to send values between threads, and if the value itself is not <code>Send</code>, it would be
unsafe to send it between threads.</p>
<h3 id="mutexguard"><a class="header" href="#mutexguard"><code>MutexGuard</code></a></h3>
<p><code>MutexGuard</code> is not <code>Send</code> because the underlying operating system primitives that <code>Mutex</code> uses to implement
the lock require (on some platforms) that the lock must be released by the same thread that acquired it.<br />
If we were to send a <code>MutexGuard</code> to another thread, the lock would be released by a different thread, which would
lead to undefined behavior.</p>
<h2 id="our-challenges"><a class="header" href="#our-challenges">Our challenges</a></h2>
<p>Summing it up:</p>
<ul>
<li>We can't send a <code>MutexGuard</code> over a channel. So we can't lock on the server-side and then modify the ticket on the
client-side.</li>
<li>We can send a <code>Mutex</code> over a channel because it's <code>Send</code> as long as the data it protects is <code>Send</code>, which is the
case for <code>Ticket</code>.
At the same time, we can't move the <code>Mutex</code> out of the <code>TicketStore</code> nor clone it.</li>
</ul>
<p>How can we solve this conundrum?<br />
We need to look at the problem from a different angle.
To lock a <code>Mutex</code>, we don't need an owned value. A shared reference is enough, since <code>Mutex</code> uses internal mutability:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T&gt; Mutex&lt;T&gt; {
    // `&amp;self`, not `self`!
    pub fn lock(&amp;self) -&gt; LockResult&lt;MutexGuard&lt;'_, T&gt;&gt; {
        // Implementation details
    }
}
<span class="boring">}</span></code></pre></pre>
<p>It is therefore enough to send a shared reference to the client.<br />
We can't do that directly, though, because the reference would have to be <code>'static</code> and that's not the case.<br />
In a way, we need an "owned shared reference". It turns out that Rust has a type that fits the bill: <code>Arc</code>.</p>
<h2 id="arc-to-the-rescue"><a class="header" href="#arc-to-the-rescue"><code>Arc</code> to the rescue</a></h2>
<p><code>Arc</code> stands for <strong>atomic reference counting</strong>.<br />
<code>Arc</code> wraps around a value and keeps track of how many references to the value exist.
When the last reference is dropped, the value is deallocated.<br />
The value wrapped in an <code>Arc</code> is immutable: you can only get shared references to it.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::sync::Arc;

let data: Arc&lt;u32&gt; = Arc::new(0);
let data_clone = Arc::clone(&amp;data);

// `Arc&lt;T&gt;` implements `Deref&lt;T&gt;`, so can convert 
// a `&amp;Arc&lt;T&gt;` to a `&amp;T` using deref coercion
let data_ref: &amp;u32 = &amp;data;
<span class="boring">}</span></code></pre></pre>
<p>If you're having a déjà vu moment, you're right: <code>Arc</code> sounds very similar to <code>Rc</code>, the reference-counted pointer we
introduced when talking about interior mutability. The difference is thread-safety: <code>Rc</code> is not <code>Send</code>, while <code>Arc</code> is.
It boils down to the way the reference count is implemented: <code>Rc</code> uses a "normal" integer, while <code>Arc</code> uses an
<strong>atomic</strong> integer, which can be safely shared and modified across threads.</p>
<h2 id="arcmutext"><a class="header" href="#arcmutext"><code>Arc&lt;Mutex&lt;T&gt;&gt;</code></a></h2>
<p>If we pair <code>Arc</code> with <code>Mutex</code>, we finally get a type that:</p>
<ul>
<li>Can be sent between threads, because:
<ul>
<li><code>Arc</code> is <code>Send</code> if <code>T</code> is <code>Send</code>, and</li>
<li><code>Mutex</code> is <code>Send</code> if <code>T</code> is <code>Send</code>.</li>
<li><code>T</code> is <code>Ticket</code>, which is <code>Send</code>.</li>
</ul>
</li>
<li>Can be cloned, because <code>Arc</code> is <code>Clone</code> no matter what <code>T</code> is.
Cloning an <code>Arc</code> increments the reference count, the data is not copied.</li>
<li>Can be used to modify the data it wraps, because <code>Arc</code> lets you get a shared
reference to <code>Mutex&lt;T&gt;</code> which can in turn be used to acquire a lock.</li>
</ul>
<p>We have all the pieces we need to implement the locking strategy for our ticket store.</p>
<h2 id="further-reading"><a class="header" href="#further-reading">Further reading</a></h2>
<ul>
<li>We won't be covering the details of atomic operations in this course, but you can find more information
<a href="https://doc.rust-lang.org/std/sync/atomic/index.html">in the <code>std</code> documentation</a> as well as in the
<a href="https://marabos.nl/atomics/">"Rust atomics and locks" book</a>.</li>
</ul>
<h2 id="exercise"><a class="header" href="#exercise">Exercise</a></h2>
<p>The exercise for this section is located in <a href="https://github.com/mainmatter/100-exercises-to-learn-rust/tree/main/exercises/07_threads/11_locks"><code>07_threads/11_locks</code></a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../07_threads/10_patch.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../07_threads/12_rw_lock.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../07_threads/10_patch.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../07_threads/12_rw_lock.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
